<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client App — ממשק לקוח ח. סבן</title>
  <!-- Tailwind + Fonts + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{--primary:#2E8B57;--bg:#F3F8F4;--muted:#607D8B}
    body{font-family:'Rubik',sans-serif;background:var(--bg);}
    .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .logo{height:56px}
    /* small mobile friendly styles */
    @media(min-width:768px){.container{max-width:880px;margin:24px auto}}
  </style>
</head>
<body class="p-4">
  <div class="container mx-auto">
    <!-- LOGIN SCREEN -->
    <section id="login-screen" class="card space-y-4">
      <div class="flex items-center gap-3">
        <img src="https://i.postimg.cc/J7JGQYcT/image.jpg" class="logo rounded-md" alt="logo">
        <h1 class="text-xl font-bold" id="app-title">ממשק לקוח — ח. סבן</h1>
      </div>
      <p class="text-sm text-[var(--muted)]">כניסה לממשק הלקוח לפי מספר טלפון. סיסמת ברירת מחדל: <strong>סבן</strong></p>
      <div class="grid grid-cols-1 gap-2">
        <input id="login-phone" placeholder="מספר טלפון (ללא +)" class="p-3 border rounded" />
        <input id="login-password" placeholder="סיסמה" class="p-3 border rounded" value="סבן" />
        <button id="btn-login" class="p-3 bg-[var(--primary)] text-white rounded font-semibold">התחבר</button>
      </div>
      <p id="login-msg" class="text-sm text-red-600 hidden"></p>
    </section>

    <!-- CLIENT DASHBOARD (hidden until auth) -->
    <section id="client-app" class="hidden space-y-4">
      <header class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img id="client-avatar" src="https://i.postimg.cc/2y9g2zYx/avatar.png" class="w-12 h-12 rounded-full" alt="avatar">
          <div>
            <div id="client-name" class="font-bold"></div>
            <div id="client-phone" class="text-sm text-[var(--muted)]"></div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-new-order" class="btn bg-[var(--primary)] text-white p-2 rounded">הזמן מכולה חדשה</button>
          <button id="btn-logout" class="p-2 border rounded">התנתק</button>
        </div>
      </header>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="card">
          <h3 class="font-semibold">מכולות בשירות</h3>
          <div id="kpi-containers" class="text-3xl font-bold mt-2">0</div>
        </div>
        <div class="card">
          <h3 class="font-semibold">הזמנות פתוחות</h3>
          <div id="kpi-open" class="text-3xl font-bold mt-2">0</div>
        </div>
        <div class="card">
          <h3 class="font-semibold">הודעות</h3>
          <div id="kpi-notifs" class="text-3xl font-bold mt-2">0</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="card" id="client-orders-card">
          <h3 class="font-semibold mb-2">רשימת ההזמנות שלך</h3>
          <div id="orders-list" class="space-y-2 max-h-72 overflow-auto"></div>
        </div>

        <div class="card" id="map-card">
          <h3 class="font-semibold mb-2">מפת מיקום והסעות</h3>
          <div id="client-map" style="height:320px;background:#eef;display:flex;align-items:center;justify-content:center;color:#7a7a7a">מפה תוצג פה</div>
        </div>
      </div>

      <div class="card" id="notifications-panel">
        <h3 class="font-semibold mb-2">לוח הודעות</h3>
        <div id="notice-list" class="space-y-2"></div>
      </div>
    </section>

    <!-- ORDER FORM MODAL (simple) -->
    <div id="order-modal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4">
      <div class="bg-white rounded p-4 w-full max-w-md">
        <h3 class="font-bold mb-2">טופס הזמנת מכולה</h3>
        <div class="space-y-2">
          <select id="order-project" class="p-2 border rounded w-full"></select>
          <input id="order-address" placeholder="כתובת / לינק Waze" class="p-2 border rounded w-full" />
          <input id="order-phone-contact" placeholder="טלפון איש קשר" class="p-2 border rounded w-full" />
          <select id="order-action-type" class="p-2 border rounded w-full"><option>הורדה</option><option>העלאה</option><option>החלפה</option><option>שירות מנוף</option></select>
          <textarea id="order-notes" placeholder="הערות" class="p-2 border rounded w-full"></textarea>
          <div class="flex gap-2 justify-end">
            <button id="order-cancel" class="p-2 border rounded">ביטול</button>
            <button id="order-submit" class="p-2 bg-[var(--primary)] text-white rounded">שלח הזמנה</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ----------------- CONFIG -----------------
    const SCRIPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxiS3wXwXCyh8xM1EdTiwXy0T-UyBRQgfrnRRis531lTxmgtJIGawfsPeetX5nVJW3V/exec';
    // default whatsapp number
    const WHATSAPP_NUMBER = '972508860896';

    // ----------------- STATE ------------------
    let client = null; // {phone,name,id,projects:[]}
    let clientOrders = [];

    // ----------------- HELPERS ---------------
    const el = id => document.getElementById(id);
    function show(sel){el(sel).classList.remove('hidden')}
    function hide(sel){el(sel).classList.add('hidden')}

    // ----------------- AUTH ------------------
    document.getElementById('btn-login').addEventListener('click', async ()=>{
      const phone = el('login-phone').value.trim();
      const password = el('login-password').value || 'סבן';
      if(!phone){el('login-msg').textContent='הכנס טלפון';el('login-msg').classList.remove('hidden');return}
      el('login-msg').classList.add('hidden');
      try{
        const res = await api('auth', { phone, password });
        if(res && res.length>0){
          client = res[0];
          onLoginSuccess();
        } else {
          el('login-msg').textContent='לא נמצאו משתמשים עם פרטי כניסה אלה';el('login-msg').classList.remove('hidden');
        }
      }catch(e){el('login-msg').textContent='שגיאה בתקשורת';el('login-msg').classList.remove('hidden');}
    });

    function onLoginSuccess(){
      hide('login-screen');
      show('client-app');
      el('client-name').textContent = client['שם לקוח'] || client.name || 'לקוח';
      el('client-phone').textContent = client['טלפון לקוח'] || client.phone;
      // avatar placeholder
      el('client-avatar').src = client.avatar || 'https://i.postimg.cc/2y9g2zYx/avatar.png';
      loadClientData();
    }

    document.getElementById('btn-logout').addEventListener('click', ()=>{client=null;clientOrders=[];hide('client-app');show('login-screen');});

    // ----------------- API WRAPPER -------------
    async function api(action, params={}){
      const url = new URL(SCRIPT_WEB_APP_URL);
      url.searchParams.append('action', action);
      Object.keys(params).forEach(k=>url.searchParams.append(k, params[k]));
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error('server');
      const data = await r.json();
      if(!data.success) throw new Error(data.message || 'api error');
      return data.data;
    }

    // ----------------- DATA LOAD ----------------
    async function loadClientData(){
      try{
        // 1) projects (from sheet column Projects linked to client phone)
        const projects = await api('getProjectsByPhone',{ phone: client['טלפון לקוח'] || client.phone });
        client.projects = projects || [];
        // populate project selector
        const sel = el('order-project'); sel.innerHTML='';
        client.projects.forEach(p=>{const opt=document.createElement('option');opt.value=p.projectName;opt.textContent=p.projectName + (p.projectAddress? ' — '+p.projectAddress:'');sel.appendChild(opt)});

        // 2) orders
        clientOrders = await api('listByPhone',{ phone: client['טלפון לקוח'] || client.phone });
        renderClientOrders();

        // 3) KPIs
        el('kpi-containers').textContent = countUniqueContainers(clientOrders);
        el('kpi-open').textContent = clientOrders.filter(o=> o['סטטוס'] !== 'סגור').length;

        // 4) notifications
        const notes = await api('getNoticesForPhone',{ phone: client['טלפון לקוח'] || client.phone });
        renderNotices(notes || []);
      }catch(e){console.error(e);alert('שגיאה בטעינת נתונים')}
    }

    function countUniqueContainers(orders){
      const set = new Set();
      orders.forEach(o=>{
        const list = String(o['מספר מכולה ירדה']||'').split(',').map(x=>x.trim()).filter(Boolean);
        list.forEach(x=>set.add(x));
      });
      return set.size;
    }

    function renderClientOrders(){
      const container = el('orders-list'); container.innerHTML='';
      if(!clientOrders || clientOrders.length===0){container.innerHTML='<div class="text-sm text-[var(--muted)]">אין הזמנות</div>'; return}
      clientOrders.sort((a,b)=> new Date(b['תאריך הזמנה']) - new Date(a['תאריך הזמנה'])).forEach(o=>{
        const div = document.createElement('div'); div.className='p-2 border rounded flex justify-between items-center';
        div.innerHTML = `<div><div class="font-semibold">${escapeHtml(o['תעודה']||'')}${o['כתובת']? ' — '+escapeHtml(o['כתובת']):''}</div><div class="text-sm text-[var(--muted)]">${escapeHtml(o['סוג פעולה']||'')} — ${escapeHtml(o['סטטוס']||'')}</div></div><div class="flex items-center gap-2"><button class="p-2 border rounded text-sm" onclick='openOrderDetails(${JSON.stringify(o).replaceAll("'","\\'")})'>פירוט</button></div>`;
        container.appendChild(div);
      });
    }

    function escapeHtml(s){return String(s||'').replace(/[&<>'"]/g,t=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[t]));}

    window.openOrderDetails = function(order){
      // open small detail modal or new window with Waze parse + map + actions
      const text = `תעודה: ${order['תעודה'] || ''}\nפעולה: ${order['סוג פעולה']||''}\nמצב: ${order['סטטוס']||''}\nכתובת: ${order['כתובת']||''}`;
      alert(text);
    }

    // ----------------- NOTICES ----------------
    function renderNotices(notes){
      el('notice-list').innerHTML='';
      notes.forEach(n=>{
        const row = document.createElement('div'); row.className='p-2 border rounded flex justify-between items-center';
        row.innerHTML = `<div><div class="font-semibold">${escapeHtml(n.title||'הודעה')}</div><div class="text-sm text-[var(--muted)]">${escapeHtml(n.message||'')}</div></div><div><button class="p-2" onclick='markNoticeRead(${JSON.stringify(n).replaceAll("'","\\'")})'>×</button></div>`;
        el('notice-list').appendChild(row);
      });
      el('kpi-notifs').textContent = notes.length;
    }

    async function markNoticeRead(n){
      try{ await api('markNoticeRead',{ id: n.id, phone: client['טלפון לקוח'] || client.phone });
        loadClientData();
      }catch(e){console.error(e)}
    }

    // ----------------- ORDER CREATION ----------------
    document.getElementById('btn-new-order').addEventListener('click', ()=>{show('order-modal')});
    document.getElementById('order-cancel').addEventListener('click', ()=>{hide('order-modal')});
    document.getElementById('order-submit').addEventListener('click', async ()=>{
      const payload = {
        phone: client['טלפון לקוח'] || client.phone,
        clientName: client['שם לקוח'] || client.name,
        project: el('order-project').value,
        address: el('order-address').value,
        contactPhone: el('order-phone-contact').value,
        actionType: el('order-action-type').value,
        notes: el('order-notes').value
      };
      try{
        await api('createOrder', payload);
        hide('order-modal');
        await loadClientData();
        // optionally send WA share link
        const waText = `הזמנה חדשה מ${payload.clientName} - ${payload.actionType} - ${payload.address}`;
        window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(waText)}`,'_blank');
      }catch(e){alert('שגיאה בשליחת ההזמנה')}
    });

    // ----------------- WAZE / SHARED LINK PARSE (חינמי) ----------------
    // example Waze share link contains encoded info — we parse query params and show to client
    function parseWazeShare(url){
      try{
        const u = new URL(url);
        const sd = u.searchParams.get('sd') || u.searchParams.get('s');
        // best-effort: show url and label
        return { raw: url, label: u.pathname + (sd? ' / '+sd:'') };
      }catch(e){return null}
    }

    // ----------------- MAP (קישור מהיר) ----------------
    // For a free, light-weight map: we can embed OSM / Leaflet in a later step.

    // ----------------- INIT ----------------
    // small demo: prefill phone if previously used
    if(localStorage.getItem('clientPhone')) el('login-phone').value = localStorage.getItem('clientPhone');

    // ----------------- ON LOAD ----------------
    document.addEventListener('DOMContentLoaded', ()=>{
      // keep minimal
    });

  </script>
</body>
</html>
