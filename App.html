<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת VIP ח. סבן - שדרוג</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/he.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1F9D55;
            --secondary-color: #f7fafc;
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--secondary-color);
            direction: rtl;
        }

        .view {
            display: none;
        }

        .active-view {
            display: block;
        }

        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
        }
        
        .card:hover {
             transform: translateY(-5px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease-in-out;
        }

        .btn-primary:hover {
            background-color: #1c8c4a;
        }

        .input {
            border-radius: 0.5rem;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            transition: border-color 0.3s;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .nav-item {
            position: relative;
            cursor: pointer;
            transition: color 0.3s ease-in-out;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            right: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 1.5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8">

        <!-- Login View -->
        <div id="login-view" class="view active-view flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md fade-in">
                <div class="flex flex-col items-center">
                    <img src="https://img.icons8.com/?size=100&id=20750&format=png&color=000000" alt="Logo" class="w-24 h-24 mb-4">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">התחברות</h1>
                </div>
                <div class="space-y-4">
                    <input id="phone-input" type="text" placeholder="מספר טלפון" class="w-full input text-right" dir="ltr">
                    <input id="password-input" type="password" placeholder="סיסמה" class="w-full input text-right" dir="ltr">
                    <button id="login-btn" class="w-full btn-primary font-semibold">
                        התחבר
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="view hidden">
            <!-- Header -->
            <header class="card p-4 flex items-center justify-between mb-6 sticky top-0 z-10 fade-in">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <img id="avatar-img" src="" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-gray-300">
                    <h2 id="welcome-message" class="text-lg font-semibold text-gray-800"></h2>
                </div>
                <nav class="flex items-center space-x-6 space-x-reverse text-gray-600 font-medium">
                    <span id="nav-dashboard" class="nav-item active" data-view="dashboard">לוח מחוונים</span>
                    <span id="nav-new-order" class="nav-item" data-view="new-order">הזמנה חדשה</span>
                    <span id="nav-chat" class="nav-item" data-view="chat">צ'אט</span>
                    <span id="nav-logout" class="nav-item text-red-500 hover:text-red-600">התנתק</span>
                </nav>
            </header>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="view active-view fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Projects Card -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">הפרויקטים שלי</h3>
                        <div id="projects-list" class="space-y-4">
                            <!-- Projects will be dynamically inserted here -->
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-full"></div>
                            </div>
                        </div>
                    </div>
                    <!-- New Orders Card -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">הזמנות פתוחות</h3>
                        <div id="new-orders-list" class="space-y-4">
                            <!-- Orders will be dynamically inserted here -->
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-full"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Active Containers Card -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">מכולות פעילות</h3>
                        <div id="active-containers-list" class="space-y-4">
                            <!-- Containers will be dynamically inserted here -->
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Order View -->
            <div id="new-order-view" class="view hidden fade-in">
                <div class="card p-6 w-full max-w-4xl mx-auto">
                    <h3 class="text-xl font-bold mb-6 text-gray-800">הזמנה חדשה</h3>
                    <form id="new-order-form" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">בחר סוג הזמנה</label>
                            <div class="flex space-x-4 space-x-reverse">
                                <button type="button" id="type-materials" class="p-3 bg-gray-200 rounded-lg flex-1 font-semibold hover:bg-gray-300 transition-colors">
                                    <i class="fa-solid fa-hard-hat ml-2"></i>חומרי בניין
                                </button>
                                <button type="button" id="type-container" class="p-3 bg-gray-200 rounded-lg flex-1 font-semibold hover:bg-gray-300 transition-colors">
                                    <i class="fa-solid fa-dumpster ml-2"></i>מכולה
                                </button>
                            </div>
                        </div>
                        
                        <!-- Common Fields -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="order-project" class="block text-gray-700 font-medium mb-2">פרויקט</label>
                                <select id="order-project" class="w-full input">
                                    <option value="">בחר פרויקט</option>
                                </select>
                            </div>
                            <div>
                                <label for="order-notes" class="block text-gray-700 font-medium mb-2">הערות</label>
                                <textarea id="order-notes" class="w-full input" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- Materials-specific fields -->
                        <div id="materials-fields" class="hidden">
                            <h4 class="text-lg font-bold my-4">בחירת חומרים</h4>
                            <div id="materials-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                <!-- Materials will be dynamically inserted here -->
                            </div>
                            <div id="selected-materials" class="mt-4 p-4 card">
                                <h5 class="font-bold">פריטים שנבחרו:</h5>
                                <ul id="selected-materials-list" class="space-y-2 mt-2"></ul>
                            </div>
                        </div>
                        
                        <!-- Container-specific fields -->
                        <div id="container-fields" class="hidden">
                            <h4 class="text-lg font-bold my-4">בחירת מכולה</h4>
                            <div>
                                <label for="container-action" class="block text-gray-700 font-medium mb-2">סוג פעולה</label>
                                <select id="container-action" class="w-full input">
                                    <option value="">בחר פעולה</option>
                                    <option value="הורדה">הורדה</option>
                                    <option value="החלפה">החלפה</option>
                                    <option value="העלאה">העלאה</option>
                                </select>
                            </div>
                            <div id="container-number-field" class="hidden mt-4">
                                <label for="container-number" class="block text-gray-700 font-medium mb-2">מספר מכולה (להחלפה/העלאה)</label>
                                <input type="text" id="container-number" class="w-full input" placeholder="מספר מכולה">
                            </div>
                        </div>

                        <button type="submit" id="submit-order-btn" class="w-full btn-primary font-semibold mt-6">
                            שלח הזמנה
                        </button>
                    </form>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chat-view" class="view hidden fade-in">
                <div class="card p-6 w-full max-w-lg mx-auto flex flex-col h-[70vh]">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">צ'אט</h3>
                    <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 p-4 border rounded-lg bg-gray-50 mb-4">
                        <!-- Chat messages will be dynamically inserted here -->
                        <div class="text-center text-gray-500">
                             טוען הודעות...
                        </div>
                    </div>
                    <div class="flex">
                        <input type="text" id="chat-input" placeholder="כתוב הודעה..." class="flex-1 input">
                        <button id="send-chat-btn" class="ml-2 btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Updated API URL for the new backend script
        const API_URL = 'https://script.google.com/macros/s/AKfycbwQlLobKoz9Y2FjievsnRXFjoDzPbgBt_dCbJAqexwToThMvsebsKY18SQHBpHE7bh7/exec';

        // The API function now handles GET and POST requests more robustly
        async function callApi(action, params = {}) {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    url.searchParams.append(key, params[key]);
                }
            }
            try {
                const response = await fetch(url.toString(), {
                    method: 'POST', // Use POST for all requests
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    return data.data;
                } else {
                    Swal.fire('שגיאה!', data.data, 'error');
                    return null;
                }
            } catch (error) {
                Swal.fire('שגיאת תקשורת!', `אירעה שגיאה: ${error.message}`, 'error');
                return null;
            }
        }

        const App = {
            state: {
                user: null,
                projects: [],
                materials: [],
                dashboardData: null,
                newOrder: {
                    type: null,
                    project: null,
                    notes: '',
                    items: [],
                    actionType: null,
                    containerNumber: null
                }
            },
            views: {},
            init() {
                this.views = {
                    login: document.getElementById('login-view'),
                    main: document.getElementById('main-view'),
                    dashboard: document.getElementById('dashboard-view'),
                    newOrder: document.getElementById('new-order-view'),
                    chat: document.getElementById('chat-view'),
                };
                this.bindEvents();
            },
            navigateTo(viewName) {
                Object.values(this.views).forEach(view => view.classList.remove('active-view'));
                if (viewName === 'main') {
                    this.views.main.classList.add('active-view');
                    document.getElementById('nav-dashboard').classList.add('active');
                } else if (this.views[viewName]) {
                    this.views.main.classList.add('active-view');
                    this.views[viewName].classList.add('active-view');
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    document.getElementById(`nav-${viewName}`).classList.add('active');
                } else if (viewName === 'login') {
                    this.views.login.classList.add('active-view');
                }
            },
            bindEvents() {
                // Login
                document.getElementById('login-btn').addEventListener('click', async () => {
                    const phone = document.getElementById('phone-input').value.trim();
                    const password = document.getElementById('password-input').value.trim();
                    if (!phone || !password) {
                        Swal.fire('שגיאה!', 'יש להזין מספר טלפון וסיסמה', 'warning');
                        return;
                    }
                    const result = await callApi('auth', { phone, password });
                    if (result) {
                        this.state.user = result;
                        this.state.projects = result.projects;
                        this.renderProjectsDropdown();
                        document.getElementById('welcome-message').textContent = `שלום, ${this.state.user['שם לקוח']}!`;
                        document.getElementById('avatar-img').src = this.state.user['avatar_url'];
                        this.navigateTo('dashboard');
                        this.fetchDashboardData();
                        this.fetchMaterials();
                    }
                });

                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const view = e.target.dataset.view;
                        if (view === 'logout') {
                            this.state.user = null;
                            this.navigateTo('login');
                        } else {
                            this.navigateTo(view);
                            if (view === 'dashboard') {
                                this.fetchDashboardData();
                            } else if (view === 'chat') {
                                this.fetchChatMessages();
                            }
                        }
                    });
                });

                // New Order Type Selection
                document.getElementById('type-materials').addEventListener('click', () => {
                    this.state.newOrder.type = 'materials';
                    document.getElementById('materials-fields').classList.remove('hidden');
                    document.getElementById('container-fields').classList.add('hidden');
                    document.getElementById('type-materials').classList.add('bg-gray-300');
                    document.getElementById('type-container').classList.remove('bg-gray-300');
                });
                document.getElementById('type-container').addEventListener('click', () => {
                    this.state.newOrder.type = 'container';
                    document.getElementById('materials-fields').classList.add('hidden');
                    document.getElementById('container-fields').classList.remove('hidden');
                    document.getElementById('type-materials').classList.remove('bg-gray-300');
                    document.getElementById('type-container').classList.add('bg-gray-300');
                });

                // Container Action Selection
                document.getElementById('container-action').addEventListener('change', (e) => {
                    const action = e.target.value;
                    if (action === 'החלפה' || action === 'העלאה') {
                        document.getElementById('container-number-field').classList.remove('hidden');
                    } else {
                        document.getElementById('container-number-field').classList.add('hidden');
                    }
                });

                // Form Submission
                document.getElementById('new-order-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = document.getElementById('submit-order-btn');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin ml-2"></i> שולח...`;

                    const selectedProject = document.getElementById('order-project').value;
                    const notes = document.getElementById('order-notes').value;
                    
                    if (!selectedProject || !this.state.newOrder.type) {
                        Swal.fire('שגיאה!', 'יש לבחור סוג הזמנה ופרויקט', 'warning');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = `שלח הזמנה`;
                        return;
                    }
                    
                    const projectData = this.state.projects.find(p => p.projectName === selectedProject);
                    
                    let result;
                    if (this.state.newOrder.type === 'materials') {
                        const items = this.state.newOrder.items.map(item => ({
                            name: item.name,
                            sku: item.sku,
                            qty: item.qty
                        }));
                        const payload = {
                            clientId: this.state.user['מזהה לקוח'],
                            clientName: this.state.user['שם לקוח'],
                            phone: this.state.user['מספר טלפון'],
                            projectName: projectData.projectName,
                            projectAddress: projectData.projectAddress,
                            notes,
                            items: JSON.stringify(items)
                        };
                        result = await callApi('createOrder', payload);
                    } else if (this.state.newOrder.type === 'container') {
                        const actionType = document.getElementById('container-action').value;
                        const containerNumber = document.getElementById('container-number').value;
                        
                        if (!actionType) {
                            Swal.fire('שגיאה!', 'יש לבחור סוג פעולה', 'warning');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = `שלח הזמנה`;
                            return;
                        }

                        const payload = {
                            clientName: this.state.user['שם לקוח'],
                            phone: this.state.user['מספר טלפון'],
                            address: projectData.projectAddress,
                            actionType,
                            notes,
                            containerNumber
                        };
                        result = await callApi('createContainerOrder', payload);
                    }
                    
                    if (result) {
                        Swal.fire('נשלח!', `הזמנה ${result.orderId} נוצרה בהצלחה.`, 'success');
                        this.navigateTo('dashboard');
                        this.fetchDashboardData();
                    }
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `שלח הזמנה`;
                });
            },
            renderProjectsDropdown() {
                const projectsDropdown = document.getElementById('order-project');
                projectsDropdown.innerHTML = '<option value="">בחר פרויקט</option>';
                this.state.projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.projectName;
                    option.textContent = project.projectName;
                    projectsDropdown.appendChild(option);
                });
            },
            fetchDashboardData() {
                // Fetch and render dashboard data
                document.getElementById('projects-list').innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                    </div>
                `;
                document.getElementById('new-orders-list').innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                    </div>
                `;
                document.getElementById('active-containers-list').innerHTML = `
                    <div class="animate-pulse">
                        <div class="h-4 bg-gray-200 rounded w-2/3 mb-2"></div>
                        <div class="h-4 bg-gray-200 rounded w-full"></div>
                    </div>
                `;
                
                // Example of how you would fetch data.
                // callApi('getDashboardData', { phone: this.state.user['מספר טלפון'] }).then(data => {
                //    if (data) {
                //        this.renderDashboard(data);
                //    }
                // });
            },
            renderDashboard(data) {
                // This is where you would update the HTML with the fetched data
                const projectsList = document.getElementById('projects-list');
                projectsList.innerHTML = '';
                data.projects.forEach(project => {
                    projectsList.innerHTML += `<div class="p-4 border rounded-lg bg-gray-50">
                        <h4 class="font-bold">${project.projectName}</h4>
                        <p class="text-sm text-gray-500">${project.projectAddress}</p>
                    </div>`;
                });
                
                // Repeat for new orders and active containers
            },
            fetchMaterials() {
                // Fetch materials from API and render them
                // callApi('getMaterials').then(data => {
                //     if (data) {
                //         this.state.materials = data;
                //         this.renderMaterialsGrid();
                //     }
                // });
            },
            renderMaterialsGrid() {
                const grid = document.getElementById('materials-grid');
                grid.innerHTML = '';
                this.state.materials.forEach(material => {
                    const materialCard = document.createElement('div');
                    materialCard.className = 'card p-4 text-center cursor-pointer hover:bg-gray-50';
                    materialCard.innerHTML = `
                        <img src="${material['קישור לתמונה']}" alt="${material['שם מוצר']}" class="w-24 h-24 mx-auto mb-2 rounded-lg object-cover">
                        <h5 class="font-bold text-sm">${material['שם מוצר']}</h5>
                        <p class="text-xs text-gray-500">${material['מק"ט']}</p>
                        <input type="number" placeholder="כמות" class="w-full text-center mt-2 input text-sm" data-sku="${material['מק"ט']}">
                    `;
                    grid.appendChild(materialCard);
                });
            },
            fetchChatMessages() {
                // Fetch chat messages and render them
                // callApi('getChatMessages', { phone: this.state.user['מספר טלפון'] }).then(data => {
                //     if (data) {
                //         this.renderChat(data);
                //     }
                // });
            },
            renderChat(messages) {
                const chatContainer = document.getElementById('chat-messages');
                chatContainer.innerHTML = '';
                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `p-3 rounded-xl max-w-[75%] ${msg.sender === 'user' ? 'bg-blue-500 text-white self-end' : 'bg-gray-300 text-gray-800 self-start'}`;
                    messageElement.textContent = msg.text;
                    chatContainer.appendChild(messageElement);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
