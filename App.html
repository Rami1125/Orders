<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול מכולות</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Favicon (fixes 404 error) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📦</text></svg>">

    <style>
        body { font-family: 'Rubik', sans-serif; }
        .bg-gradient-primary { background-image: linear-gradient(to right, #2E8B57, #3CB371); }
        .tab-active { border-bottom: 2px solid #2E8B57; color: #2E8B57; font-weight: 600; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .highlight-new {
            animation: highlight 3s ease-out;
        }
        @keyframes highlight {
            0%, 100% { background-color: transparent; }
            20%, 80% { background-color: #fefcbf; } /* yellow-100 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- App Container -->
    <div id="app" class="max-w-md mx-auto bg-white shadow-lg h-screen flex flex-col">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full p-8 fade-in">
             <h1 class="text-4xl font-bold text-gray-700 mb-2">מערכת ניהול</h1>
             <h2 class="text-xl font-light text-gray-500 mb-8">ח. סבן בע"מ</h2>
             <div class="w-full">
                 <input id="phone" type="tel" placeholder="מספר טלפון" class="w-full p-3 mb-4 border rounded-lg text-center" value="972508860896">
                 <input id="password" type="password" placeholder="סיסמה" class="w-full p-3 mb-6 border rounded-lg text-center" value="סבן">
                 <button id="login-btn" class="w-full bg-gradient-primary text-white p-3 rounded-lg font-bold shadow-md hover:opacity-90 transition">
                     <i class="fas fa-sign-in-alt mr-2"></i> כניסה
                 </button>
             </div>
        </div>

        <!-- Main App (hidden initially) -->
        <main id="main-app" class="hidden flex-grow flex flex-col">
            <!-- Header -->
            <header class="p-4 bg-gray-100 border-b flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">שלום, <span id="client-name"></span></h1>
                    <p id="typing-notice" class="text-sm text-green-600 h-5"></p>
                </div>
                <!-- NEW DEBUG BUTTON -->
                <button id="debug-btn" class="bg-red-500 text-white p-2 rounded-lg text-xs">
                    <i class="fas fa-bug"></i> הצג נתונים
                </button>
                <button id="notifications-btn" class="relative text-gray-500">
                    <i class="fas fa-bell text-2xl"></i>
                    <span id="notice-dot" class="hidden absolute top-0 right-0 h-3 w-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></span>
                </button>
            </header>
            
            <!-- Content Area -->
            <div id="content" class="flex-grow p-4 overflow-y-auto">
                <!-- Content will be injected here -->
            </div>

            <!-- Bottom Navigation -->
            <nav class="grid grid-cols-5 items-center p-2 bg-white border-t-2 shadow-inner">
                <button data-screen="home" class="nav-btn text-gray-500 flex flex-col items-center">
                    <i class="fas fa-home text-xl"></i><span class="text-xs">בית</span>
                </button>
                <button data-screen="orders" class="nav-btn text-gray-500 flex flex-col items-center">
                    <i class="fas fa-list-alt text-xl"></i><span class="text-xs">הזמנות</span>
                </button>
                <button data-screen="new-order" class="bg-gradient-primary text-white rounded-full w-16 h-16 flex items-center justify-center text-3xl shadow-lg -mt-8">
                    <i class="fas fa-plus"></i>
                </button>
                <button data-screen="map" class="nav-btn text-gray-500 flex flex-col items-center">
                    <i class="fas fa-map-marker-alt text-xl"></i><span class="text-xs">מפה</span>
                </button>
                 <button data-screen="catalog" class="nav-btn text-gray-500 flex flex-col items-center relative">
                    <i class="fas fa-book-open text-xl"></i><span class="text-xs">קטלוג</span>
                    <span id="cart-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span>
                </button>
            </nav>
        </main>

    </div> <!-- End App Container -->
    
    <!-- Order Details Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div id="order-modal-content" class="bg-white rounded-lg w-full max-w-md max-h-[90vh] flex flex-col">
            <!-- Modal content will be injected here -->
        </div>
    </div>
    
    <!-- Cart Drawer -->
    <div id="cart-drawer" class="fixed inset-0 hidden z-30">
        <div id="cart-overlay" class="absolute inset-0 bg-black bg-opacity-50"></div>
        <div id="cart-content" class="absolute right-0 top-0 h-full w-4/5 max-w-sm bg-white shadow-xl flex flex-col transition-transform translate-x-full">
            <!-- Cart content will be injected here -->
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby-cI1kev1KsbB1S830IML9dlcEZ6vtRoROT1PsYmyo7AIZP0U2KSBS_P9gZz0vKCGZqA/exec';

        // --- STATE ---
        let state = {
            client: null,
            orders: [],
            notices: [],
            catalog: [],
            cart: [],
            currentScreen: 'login',
        };

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const contentDiv = document.getElementById('content');
        const loginBtn = document.getElementById('login-btn');
        // ... other elements will be selected as needed

        // --- API COMMUNICATION ---
        async function api(action, params = {}) {
            const url = new URL(GAS_WEB_APP_URL);
            url.searchParams.set('action', action);
            Object.keys(params).forEach(key => url.searchParams.set(key, params[key]));

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'API call failed');
                }
                return result.data;
            } catch (error) {
                console.error(`API Error on action '${action}':`, error);
                Swal.fire({
                    icon: 'error',
                    title: 'שגיאת תקשורת',
                    text: error.message,
                });
                return null; // Return null to allow graceful failure
            }
        }
        
        // --- LOGIN LOGIC ---
        async function handleLogin() {
            const phone = document.getElementById('phone').value;
            const password = document.getElementById('password').value;
            if (!phone || !password) {
                Swal.fire('שדות חסרים', 'נא למלא מספר טלפון וסיסמה', 'warning');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מתחבר...';

            const clientData = await api('auth', { phone, password });

            if (clientData) {
                state.client = clientData;
                await initializeMainApp();
            } else {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt mr-2"></i> כניסה';
            }
        }
        
        // --- APP INITIALIZATION ---
        async function initializeMainApp() {
            document.getElementById('client-name').textContent = state.client['שם_לקוח'];
            
            // Fetch initial data
            const [orders, notices, catalog] = await Promise.all([
                api('listByPhone', { phone: state.client['טלפון_לקוח'] }),
                api('getNoticesForPhone', { phone: state.client['טלפון_לקוח'] }),
                api('listCatalog')
            ]);
            
            state.orders = orders || [];
            state.notices = notices || [];
            state.catalog = catalog || [];
            
            // Animate transition
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            mainApp.classList.add('fade-in', 'flex');

            setupNavigation();
            navigateTo('home');
            startTypingEffect();
            updateNoticeDot();
            
            // Setup the new debug button
            document.getElementById('debug-btn').addEventListener('click', () => {
                Swal.fire({
                    title: 'Current App Data (State)',
                    html: `<pre style="text-align: left; direction: ltr; background-color: #f0f0f0; padding: 10px; border-radius: 5px;">${JSON.stringify(state, null, 2)}</pre>`,
                    confirmButtonText: 'סגור'
                });
            });
        }
        
        // --- NAVIGATION ---
        function setupNavigation() {
            document.querySelectorAll('.nav-btn, [data-screen="new-order"]').forEach(btn => {
                btn.addEventListener('click', () => navigateTo(btn.dataset.screen));
            });
        }
        
        function navigateTo(screen) {
            state.currentScreen = screen;
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                 if (btn.dataset.screen === screen) {
                     btn.classList.add('text-green-600');
                 } else {
                     btn.classList.remove('text-green-600');
                 }
            });

            contentDiv.innerHTML = ''; // Clear previous content
            
            switch (screen) {
                case 'home':
                    renderHomeScreen();
                    break;
                case 'orders':
                    renderOrdersScreen();
                    break;
                case 'map':
                    renderMapScreen();
                    break;
                case 'catalog':
                    renderCatalogScreen();
                    break;
                case 'new-order':
                    renderNewOrderScreen();
                    break;
            }
        }
        
        // --- RENDERING FUNCTIONS (Templates) ---
        function renderHomeScreen() {
            contentDiv.innerHTML = `
                <div class="fade-in">
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-100 p-4 rounded-lg text-center">
                            <p class="text-3xl font-bold text-blue-800">${state.orders.filter(o=>o.סטטוס !== 'בוצע' && o.סטטוס !== 'בוטל').length}</p>
                            <p class="text-sm text-blue-600">הזמנות פעילות</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <p class="text-3xl font-bold text-green-800">${state.orders.filter(o=>o.סטטוס === 'בוצע').length}</p>
                            <p class="text-sm text-green-600">הזמנות שהושלמו</p>
                        </div>
                    </div>
                    <h2 class="font-semibold text-lg mb-2">הודעות אחרונות</h2>
                    <div id="notices-container" class="space-y-2">
                        ${state.notices.length > 0 ? state.notices.map(n => `
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                                <p class="font-bold">${n.title}</p>
                                <p>${n.message}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500">אין הודעות חדשות.</p>'}
                    </div>
                </div>
            `;
        }

        function renderOrdersScreen() {
             contentDiv.innerHTML = `
                <div class="fade-in">
                    <div id="orders-list" class="space-y-3">
                        ${state.orders.length > 0 ? state.orders.map(orderCard).join('') : '<p class="text-gray-500 text-center mt-8">לא נמצאו הזמנות.</p>'}
                    </div>
                </div>
            `;
            document.querySelectorAll('.order-card').forEach(card => {
                card.addEventListener('click', () => showOrderDetails(card.dataset.orderId));
            });
        }
        
        function orderCard(order, isNew = false) {
            const statusStyles = {
                'ממתין לביצוע': 'bg-yellow-500',
                'בדרך': 'bg-blue-500',
                'בוצע': 'bg-green-500',
                'בוטל': 'bg-red-500',
            };
            return `
                <div class="order-card bg-white p-4 rounded-lg shadow-md border-l-4 ${statusStyles[order.סטטוס] || 'bg-gray-500'}" data-order-id="${order.תעודה}" ${isNew ? 'class="highlight-new"' : ''}>
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-lg">${order.פרויקט}</p>
                        <p class="text-sm text-gray-500">${order.תעודה}</p>
                    </div>
                    <p class="text-gray-600">${order.כתובת}</p>
                    <div class="flex justify-between items-center mt-2">
                         <span class="text-sm font-semibold text-white px-2 py-1 rounded-full ${statusStyles[order.סטטוס] || 'bg-gray-500'}">${order.סטטוס}</span>
                        <span class="text-sm text-gray-500">${dayjs(order.תאריך_הזמנה).format('DD/MM/YYYY')}</span>
                    </div>
                </div>
            `;
        }
        
        function renderMapScreen() {
            contentDiv.innerHTML = `<div id="map-container" class="h-full w-full rounded-lg" style="height: 60vh;"></div>`;
            setTimeout(() => { // Allow DOM to update before initializing map
                const map = L.map('map-container').setView([32.0853, 34.7818], 8); // Centered on Tel Aviv
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                // Placeholder for adding markers
                L.marker([32.0853, 34.7818]).addTo(map).bindPopup('מכולה בפרויקט תל אביב');
            }, 100);
        }

        function renderCatalogScreen() {
             contentDiv.innerHTML = `
                <div class="fade-in">
                    <h2 class="text-xl font-semibold mb-4">קטלוג מוצרים</h2>
                    <div id="catalog-grid" class="grid grid-cols-2 gap-4">
                        ${state.catalog.map(productCard).join('')}
                    </div>
                </div>
            `;
            document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sku = e.currentTarget.dataset.sku;
                    addToCart(sku);
                });
            });
             document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Logic to show product details if needed
                });
            });
        }
        
        function productCard(product) {
            return `
                <div class="product-card bg-white p-3 rounded-lg shadow cursor-pointer">
                    <img src="${product.imageUrl || 'https://placehold.co/300x200?text=No+Image'}" class="w-full h-24 object-cover rounded-md mb-2">
                    <h3 class="font-semibold text-sm">${product.productName}</h3>
                    <p class="text-xs text-gray-500 mb-2">${product.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-green-600">₪${product.price}</span>
                        <button class="add-to-cart-btn bg-green-500 text-white rounded-full w-8 h-8 flex items-center justify-center" data-sku="${product.sku}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // --- ORDER DETAILS MODAL ---
        function showOrderDetails(orderId) {
             const order = state.orders.find(o => o.תעודה === orderId);
             if (!order) return;
             const modal = document.getElementById('order-modal');
             const modalContent = document.getElementById('order-modal-content');

             let itemsHtml = 'אין פריטים';
             try {
                const items = JSON.parse(order.פריטים);
                if (Array.isArray(items) && items.length > 0) {
                    itemsHtml = `<ul>${items.map(item => `<li>- ${item.name} (כמות: ${item.qty})</li>`).join('')}</ul>`;
                }
             } catch (e) { console.error('Could not parse items JSON'); }
             
             modalContent.innerHTML = `
                <header class="p-4 bg-gray-100 rounded-t-lg flex justify-between items-center">
                    <h2 class="font-semibold text-lg">פרטי הזמנה ${order.תעודה}</h2>
                    <button id="close-modal-btn" class="text-gray-500 text-2xl">&times;</button>
                </header>
                <div class="p-4 overflow-y-auto">
                    <p><strong>פרויקט:</strong> ${order.פרויקט}</p>
                    <p><strong>כתובת:</strong> ${order.כתובת}</p>
                    <p><strong>סטטוס:</strong> ${order.סטטוס}</p>
                    <p><strong>תאריך:</strong> ${dayjs(order.תאריך_הזמנה).format('DD/MM/YYYY')}</p>
                    <p><strong>מספר מכולה:</strong> ${order['מס׳_מכולה'] || 'לא שויך'}</p>
                    <div class="mt-2 p-2 bg-gray-50 rounded">
                        <h3 class="font-semibold mb-1">פריטים:</h3>
                        ${itemsHtml}
                    </div>
                </div>
                <footer class="p-3 bg-gray-100 rounded-b-lg grid grid-cols-2 gap-2">
                    <button class="bg-green-500 text-white p-2 rounded-lg"><i class="fab fa-whatsapp"></i> שתף בווטסאפ</button>
                    <button class="bg-blue-500 text-white p-2 rounded-lg"><i class="fas fa-print"></i> הדפס</button>
                </footer>
             `;

             modal.classList.remove('hidden');
             modal.classList.add('flex');
             document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));
        }

        // --- CART LOGIC ---
        function addToCart(sku, quantity = 1) {
            const product = state.catalog.find(p => p.sku === sku);
            if (!product) return;
            
            const existingItem = state.cart.find(item => item.sku === sku);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                state.cart.push({ ...product, quantity });
            }
            updateCartUI();
            
            // Show confirmation
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
            });
            Toast.fire({
                icon: 'success',
                title: `${product.productName} נוסף לסל`
            });
        }
        
        function updateCartUI() {
            const cartCount = document.getElementById('cart-count');
            const totalItems = state.cart.reduce((sum, item) => sum + item.quantity, 0);
            if (totalItems > 0) {
                cartCount.textContent = totalItems;
                cartCount.classList.remove('hidden');
            } else {
                cartCount.classList.add('hidden');
            }
        }
        
        // --- MISC ---
        function startTypingEffect() {
            const notice = state.notices.length > 0 ? state.notices[0].title : "אין עדכונים חדשים";
            const typingElement = document.getElementById('typing-notice');
            let i = 0;
            typingElement.innerHTML = "";
            function type() {
                if (i < notice.length) {
                    typingElement.innerHTML += notice.charAt(i);
                    i++;
                    setTimeout(type, 50);
                }
            }
            type();
        }
        
        function updateNoticeDot() {
            // Placeholder: logic to check if notices are unread
            if (state.notices.length > 0) {
                 document.getElementById('notice-dot').classList.remove('hidden');
            } else {
                document.getElementById('notice-dot').classList.add('hidden');
            }
        }

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });


    </script>
</body>
</html>

