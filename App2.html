<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP Portal | ח. סבן בע"מ</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Favicon -->
    <link rel="icon" href="https://img.icons8.com/plasticine/100/000000/truck.png">

    <style>
        :root {
            --primary-color: #2E8B57; /* Sea Green */
            --primary-hover: #3CB371;
            --secondary-color: #4682B4; /* Steel Blue for materials */
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #343a40;
            --vip-gold: #FFD700;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Rubik', sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .app-shell {
            background: url('https://www.transparenttextures.com/patterns/cubes.png'), var(--background-color);
            border: 10px solid #1a1a1a;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), inset 0 0 15px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.5s ease-out forwards; }
        @keyframes blink { 50% { opacity: 0; } }
        .blinking-dot { animation: blink 1.5s linear infinite; }
        
        @keyframes highlight-new-order {
            0%, 100% { background-color: transparent; }
            20%, 80% { background-color: #e6f7ff; box-shadow: 0 0 15px rgba(52, 152, 219, 0.5); }
        }
        .highlight-new { animation: highlight-new-order 3s ease-out forwards; }
        
        #scrollTopBtn { position: fixed; bottom: 7rem; left: 1.5rem; background-color: rgba(0, 0, 0, 0.5); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; opacity: 0; transition: opacity 0.3s, transform 0.3s; z-index: 1000; }
        #scrollTopBtn:hover { transform: scale(1.1); }

        .lightbox { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .lightbox.show { opacity: 1; pointer-events: all; }
        .lightbox img { max-width: 90%; max-height: 80%; border-radius: 8px; }
        
        .chat-bubble { max-width: 75%; padding: 10px 15px; border-radius: 20px; word-wrap: break-word; }
        .chat-user { background-color: var(--primary-color); color: white; border-bottom-right-radius: 5px; }
        .chat-agent { background-color: #e9ecef; color: var(--text-color); border-bottom-left-radius: 5px; }
        
        .choice-btn { border: 2px solid #e5e7eb; padding: 1rem; border-radius: 0.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .choice-btn.selected { border-color: var(--primary-color); background-color: #e6f7ff; color: var(--primary-color); font-weight: bold; }
    </style>
</head>
<body class="flex justify-center items-center h-screen">

    <div class="app-shell max-w-md w-full h-full md:h-[95vh] md:max-h-[800px] flex flex-col">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full p-8 fade-in" style="background: linear-gradient(135deg, #2E8B57, #2c3e50);">
            <img id="login-avatar" src="https://i.imgur.com/your-logo.png" class="w-24 h-24 rounded-full border-4 border-white shadow-lg mb-6" alt="Logo">
            <div class="w-full text-center">
                <h1 class="text-3xl font-bold text-white mb-2">VIP Portal</h1>
                <p class="text-gray-300 mb-8">בלעדי ללקוחות ח. סבן בע"מ</p>
                 <div class="relative mb-4">
                    <i class="fas fa-phone absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input id="phone" type="tel" placeholder="מספר טלפון" class="w-full p-3 pl-12 border-2 border-transparent focus:border-green-400 focus:ring-0 rounded-full text-center transition" value="972508860896">
                </div>
                <div class="relative mb-6">
                     <i class="fas fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input id="password" type="password" placeholder="סיסמה" class="w-full p-3 pl-12 border-2 border-transparent focus:border-green-400 focus:ring-0 rounded-full text-center transition" value="סבן">
                </div>
                <button id="login-btn" class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white p-3 rounded-full font-bold shadow-lg hover:scale-105 transform transition">
                     כניסה למערכת
                </button>
            </div>
        </div>

        <!-- Main App (hidden initially) -->
        <main id="main-app" class="hidden flex-grow flex flex-col bg-white">
            <header class="p-4 bg-white border-b flex justify-between items-center sticky top-0 z-10">
                <div class="flex items-center">
                    <span id="online-indicator" class="w-3 h-3 bg-green-400 rounded-full mr-3 blinking-dot"></span>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-800">שלום, <span id="client-name"></span></h1>
                        <div id="live-clock" class="text-xs text-gray-500"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="chat-btn" class="relative text-gray-600"><i class="fas fa-comments text-2xl"></i><span id="chat-dot" class="hidden absolute top-0 right-0 h-3 w-3 bg-red-500 rounded-full border-2 border-white animate-pulse"></span></button>
                </div>
            </header>
            
            <div id="content" class="flex-grow p-4 overflow-y-auto"></div>

            <nav class="grid grid-cols-5 items-center p-2 bg-white border-t shadow-inner mt-auto">
                <button data-screen="home" class="nav-btn text-gray-500 flex flex-col items-center"><i class="fas fa-th-large text-xl"></i><span class="text-xs mt-1">ראשי</span></button>
                <button data-screen="containers" class="nav-btn text-gray-500 flex flex-col items-center"><i class="fas fa-truck text-xl"></i><span class="text-xs mt-1">מכולות</span></button>
                <button id="new-order-choice-btn" class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full w-16 h-16 flex items-center justify-center text-3xl shadow-lg -mt-8 transform hover:scale-110 transition"><i class="fas fa-plus"></i></button>
                <button data-screen="materials" class="nav-btn text-gray-500 flex flex-col items-center"><i class="fas fa-cubes text-xl"></i><span class="text-xs mt-1">חומרים</span></button>
                <button data-screen="map" class="nav-btn text-gray-500 flex flex-col items-center"><i class="fas fa-map-marked-alt text-xl"></i><span class="text-xs mt-1">מפה</span></button>
            </nav>
        </main>
        
        <div id="modals-container"></div>
        <div id="image-lightbox" class="lightbox" onclick="this.classList.remove('show')"><img></div>
        <button id="scrollTopBtn" onclick="document.getElementById('content').scrollTop = 0;"><i class="fas fa-arrow-up"></i></button>
    </div>

    <script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby-cI1kev1KsbB1S830IML9dlcEZ6vtRoROT1PsYmyo7AIZP0U2KSBS_P9gZz0vKCGZqA/exec'; // <-- החלף בכתובת שלך!
    let state = { client: null, currentScreen: 'login', catalog: [], orders: [] };

    const contentDiv = document.getElementById('content');
    const modalsContainer = document.getElementById('modals-container');
    const scrollTopBtn = document.getElementById('scrollTopBtn');

    async function api(action, params = {}) {
        // FIX: Check if the URL is a placeholder and show a user-friendly error.
        if (GAS_WEB_APP_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL')) {
            Swal.fire({
                icon: 'error',
                title: 'הגדרה חסרה',
                html: 'יש לעדכן את כתובת ה-API בקוד.<br>החלף את <code>YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL</code> בכתובת שקיבלת מ-Google Apps Script.',
                confirmButtonText: 'הבנתי'
            });
            return null;
        }

        const url = new URL(GAS_WEB_APP_URL);
        url.searchParams.set('action', action);
        Object.entries(params).forEach(([key, value]) => url.searchParams.set(key, value));
        try {
            const res = await fetch(url);
            const result = await res.json();
            if (!result.success) throw new Error(result.message);
            return result.data;
        } catch (error) {
            Swal.fire('שגיאת תקשורת', error.message, 'error');
            return null;
        }
    }
    
    async function initializeMainApp() {
        document.getElementById('client-name').textContent = state.client['שם_לקוח'];
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden', 'flex');
        document.getElementById('main-app').classList.add('fade-in', 'flex');

        state.orders = await api('listOrders', { phone: state.client['טלפון_לקוח'] }) || [];
        
        setupEventListeners();
        updateClock();
        setInterval(updateClock, 1000);
        navigateTo('home');
    }

    function setupEventListeners() {
        document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.screen)));
        document.getElementById('new-order-choice-btn').addEventListener('click', showNewOrderChoice);
        contentDiv.addEventListener('scroll', () => { scrollTopBtn.style.opacity = contentDiv.scrollTop > 200 ? '1' : '0'; });
    }
    
    function navigateTo(screen) {
        state.currentScreen = screen;
        contentDiv.innerHTML = '';
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('text-green-600', btn.dataset.screen === screen));
        const renderer = window[`render${screen.charAt(0).toUpperCase() + screen.slice(1)}Screen`];
        if (renderer) renderer();
    }
    
    function renderHomeScreen() {
        const containerOrders = state.orders.filter(o => o.orderType === 'container');
        const materialsOrders = state.orders.filter(o => o.orderType === 'materials');
        contentDiv.innerHTML = `
        <div class="space-y-6 slide-up">
            <div>
                <h2 class="text-xl font-bold mb-2 flex items-center"><i class="fas fa-truck text-green-600 mr-3"></i>מכולות פעילות</h2>
                <div id="container-orders-list" class="bg-white p-2 rounded-lg shadow space-y-2">
                    ${containerOrders.length > 0 ? containerOrders.map(orderRow).join('') : '<p class="text-center text-gray-500 p-4">אין מכולות פעילות</p>'}
                </div>
            </div>
            <div>
                <h2 class="text-xl font-bold mb-2 flex items-center"><i class="fas fa-cubes text-blue-600 mr-3"></i>הזמנות חומרים</h2>
                 <div id="materials-orders-list" class="bg-white p-2 rounded-lg shadow space-y-2">
                    ${materialsOrders.length > 0 ? materialsOrders.map(orderRow).join('') : '<p class="text-center text-gray-500 p-4">אין הזמנות חומרים</p>'}
                 </div>
            </div>
        </div>`;
    }

    function orderRow(order) {
        const statusColors = { 'ממתין לאישור': 'bg-yellow-400', 'בטיפול': 'bg-blue-400', 'בוצע': 'bg-green-400' };
        return `
        <div id="order-${order.תעודה}" class="p-3 border-b last:border-b-0">
            <div class="flex justify-between items-center">
                <span class="font-bold">${order.פרויקט}</span>
                <span class="text-xs px-2 py-1 rounded-full text-white ${statusColors[order.סטטוס] || 'bg-gray-400'}">${order.סטטוס}</span>
            </div>
            <div class="text-sm text-gray-600">${order.כתובת}</div>
        </div>`;
    }

    function showNewOrderChoice() {
        Swal.fire({
            title: 'בחר סוג הזמנה',
            html: `
                <div class="flex justify-around p-4">
                    <button id="swal-order-container" class="p-4 bg-green-100 rounded-lg text-green-800 font-semibold w-32 h-32 flex flex-col justify-center items-center transform hover:scale-105 transition">
                        <i class="fas fa-truck text-4xl mb-2"></i><span>הזמנת מכולה</span>
                    </button>
                    <button id="swal-order-materials" class="p-4 bg-blue-100 rounded-lg text-blue-800 font-semibold w-32 h-32 flex flex-col justify-center items-center transform hover:scale-105 transition">
                        <i class="fas fa-cubes text-4xl mb-2"></i><span>הזמנת חומרים</span>
                    </button>
                </div>`,
            showConfirmButton: false,
            willOpen: () => {
                document.getElementById('swal-order-container').addEventListener('click', () => { renderNewOrderModal('container'); Swal.close(); });
                document.getElementById('swal-order-materials').addEventListener('click', () => { /* Logic for materials form */ Swal.close(); });
            }
        });
    }

    function renderNewOrderModal(type) {
        const title = 'הזמנת מכולה חדשה';
        modalsContainer.innerHTML = `
            <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40">
                <div class="bg-white rounded-lg w-full max-w-md max-h-[90vh] flex flex-col slide-up">
                    <header class="p-4 bg-gray-100 rounded-t-lg flex justify-between items-center">
                        <h2 class="font-semibold text-lg">${title}</h2>
                        <button onclick="closeModal('order-modal')" class="text-gray-500 text-2xl">&times;</button>
                    </header>
                    <div class="p-4 overflow-y-auto">${getContainerFormHtml()}</div>
                    <footer class="p-3 bg-gray-100 rounded-b-lg text-left">
                        <button id="send-order-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold">שלח הזמנה</button>
                    </footer>
                </div>
            </div>`;
        document.getElementById('send-order-btn').addEventListener('click', () => handleSendOrder('container'));
        setupChoiceButtons();
    }
    
    function getContainerFormHtml() {
        return `
            <div class="space-y-4 text-right">
                <div><label class="font-semibold">פרויקט:</label><input id="form-project" type="text" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="font-semibold">כתובת:</label><input id="form-address" type="text" class="w-full p-2 border rounded mt-1"></div>
                <div>
                    <label class="font-semibold mb-2 block">סוג המכולה:</label>
                    <div class="grid grid-cols-3 gap-2" data-group="containerType">
                        <button class="choice-btn" data-value="8 רגל">8 רגל</button>
                        <button class="choice-btn" data-value="10 רגל">10 רגל</button>
                        <button class="choice-btn" data-value="פסולת בניין">פסולת</button>
                    </div>
                </div>
                <div>
                    <label class="font-semibold mb-2 block">סוג השכירות:</label>
                    <div class="grid grid-cols-3 gap-2" data-group="rentalType">
                        <button class="choice-btn" data-value="חודשית">חודשית</button>
                        <button class="choice-btn" data-value="פינוי">פינוי</button>
                        <button class="choice-btn" data-value="החלפה">החלפה</button>
                    </div>
                </div>
                <div><label class="font-semibold">הערות:</label><textarea id="form-notes" class="w-full p-2 border rounded mt-1"></textarea></div>
            </div>`;
    }

    function setupChoiceButtons() {
        document.querySelectorAll('[data-group]').forEach(group => {
            group.addEventListener('click', e => {
                if (e.target.classList.contains('choice-btn')) {
                    group.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            });
        });
    }
    
    async function handleSendOrder(orderType) {
        const project = document.getElementById('form-project').value;
        const address = document.getElementById('form-address').value;
        const containerType = document.querySelector('[data-group="containerType"] .selected')?.dataset.value;
        const rentalType = document.querySelector('[data-group="rentalType"] .selected')?.dataset.value;
        const notes = document.getElementById('form-notes').value;

        if (!project || !address || !containerType || !rentalType) {
            Swal.fire('פרטים חסרים', 'יש למלא את כל השדות', 'warning');
            return;
        }

        const items = [{ type: containerType, rental: rentalType, notes: notes }];
        
        const orderData = {
            phone: state.client['טלפון_לקוח'],
            orderType: orderType,
            items: JSON.stringify(items),
            project: project,
            address: address,
        };

        const newOrder = await api('createOrder', orderData);

        if (newOrder) {
            closeModal('order-modal');
            state.orders.unshift(newOrder); // Add to the beginning of the list
            navigateTo('home'); // Refresh home screen
            
            setTimeout(() => {
                document.getElementById(`order-${newOrder.תעודה}`)?.classList.add('highlight-new');
            }, 100);

            const whatsappMessage = encodeURIComponent(`*הזמנת מכולה חדשה* \n\n*לקוח:* ${state.client['שם_לקוח']}\n*פרויקט:* ${project}\n*כתובת:* ${address}\n*סוג:* ${containerType}, ${rentalType}`);
            Swal.fire({
                icon: 'success',
                title: 'ההזמנה נשלחה בהצלחה!',
                html: 'היא מופיעה כעת בדף הראשי וממתינה לאישור.',
                confirmButtonText: 'מצוין',
                showCancelButton: true,
                cancelButtonText: `<i class="fab fa-whatsapp"></i> שתף בווטסאפ`,
                cancelButtonColor: '#25D366'
            }).then(result => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    window.open(`https://api.whatsapp.com/send?text=${whatsappMessage}`);
                }
            });
        }
    }
    
    function closeModal(modalId) { document.getElementById(modalId)?.remove(); }
    function updateClock() { dayjs.locale('he'); document.getElementById('live-clock').textContent = dayjs().format('dddd, D MMMM YYYY | HH:mm:ss'); }

    // --- INIT ---
    document.getElementById('login-btn').addEventListener('click', async () => {
        const btn = document.getElementById('login-btn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מאמת פרטים...';
        state.client = await api('auth', { 
            phone: document.getElementById('phone').value,
            password: document.getElementById('password').value
        });
        if (state.client) initializeMainApp();
        else btn.innerHTML = 'כניסה למערכת';
    });
    </script>
</body>
</html>

